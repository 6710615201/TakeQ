{% extends "base.html" %}
{% load static %}

{% block title %}<title>{% if is_new %}Add Question{% else %}Edit Question{% endif %}</title>{% endblock %}

{% block content %}
<div class="container py-3">
  <h2 class="mb-3">{% if is_new %}Add Question{% else %}Edit Question{% endif %}</h2>

  <form method="post" id="question-form">
    {% csrf_token %}

    {# Question non-field errors #}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}

    <div class="mb-3">
      {{ form.text.label_tag }}
      {{ form.text }}
      {% if form.text.errors %}
        <div class="text-danger small">{{ form.text.errors }}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      {{ form.qtype.label_tag }}
      {{ form.qtype }}
      {% if form.qtype.errors %}
        <div class="text-danger small">{{ form.qtype.errors }}</div>
      {% endif %}
    </div>

    {{ form.order }} {# hidden widget expected from form definition #}

    <div id="choices-block" class="mb-3" {% if not formset %}style="display:none"{% endif %}>
      <div class="d-flex align-items-center mb-2">
        <button type="button" class="btn btn-sm btn-outline-primary me-2" id="add-choice-btn">Add choice</button>
        <div class="form-text">For MCQ: at least 2 choices required and exactly one must be correct.</div>
      </div>

      {% if formset %}
        {{ formset.management_form }}

        {% if formset.non_form_errors %}
          <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
        {% endif %}

        <div id="choices-container">
          {# Existing bound forms (render fields explicitly, DELETE as hidden) #}
          {% for f in formset.forms %}
            <div class="choice-item mb-2 border rounded p-2" data-form-index="{{ forloop.counter0 }}">
              {% for hidden in f.hidden_fields %}
                {{ hidden }}
              {% endfor %}

              <div class="mb-2">
                {{ f.text.label_tag }} {{ f.text }}
                {% if f.text.errors %}
                  <div class="text-danger small">{{ f.text.errors }}</div>
                {% endif %}
              </div>

              <div class="form-check mb-2">
                {{ f.is_correct }} {{ f.is_correct.label_tag }}
                {% if f.is_correct.errors %}
                  <div class="text-danger small">{{ f.is_correct.errors }}</div>
                {% endif %}
              </div>

              {# show DELETE as hidden input only #}
              {% if f.DELETE %}
                <input type="hidden" name="{{ f.DELETE.html_name }}" id="{{ f.DELETE.auto_id }}" value="{{ f.DELETE.value|default_if_none:'' }}">
              {% endif %}

              <button type="button" class="btn btn-sm btn-danger remove-choice-btn">Remove</button>
            </div>
          {% endfor %}
        </div>

        {# Empty form template for JS cloning - render visible fields explicitly #}
        <div id="empty-form-template" style="display:none">
          <div class="choice-item mb-2 border rounded p-2" data-form-index="__prefix__">
            <div class="mb-2">
              {{ formset.empty_form.text.label_tag }} {{ formset.empty_form.text }}
            </div>
            <div class="form-check mb-2">
              {{ formset.empty_form.is_correct }} {{ formset.empty_form.is_correct.label_tag }}
            </div>
            <input type="hidden" name="{{ formset.empty_form.DELETE.html_name }}" value="">
            <button type="button" class="btn btn-sm btn-danger remove-choice-btn">Remove</button>
          </div>
        </div>
      {% endif %}
    </div>

    <div class="mt-3">
      <button class="btn btn-primary" type="submit">Save</button>
      <a class="btn btn-secondary ms-2" href="{% if is_new %}{% url 'create_quiz:quiz_detail' quiz.pk %}{% else %}{% url 'create_quiz:quiz_detail' question.quiz.pk %}{% endif %}">Cancel</a>
    </div>
  </form>
</div>

<script>
(function(){
  const qtypeSelect = document.querySelector('#id_qtype');
  const choicesBlock = document.getElementById('choices-block');
  const addBtn = document.getElementById('add-choice-btn');
  const container = document.getElementById('choices-container');
  const emptyTplEl = document.getElementById('empty-form-template');
  const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');

  function toggleByQtype(){
    const v = qtypeSelect ? qtypeSelect.value : null;
    if(v === 'mcq'){
      if(choicesBlock) choicesBlock.style.display = 'block';
    } else {
      if(choicesBlock) choicesBlock.style.display = 'none';
    }
  }

  if(qtypeSelect){
    qtypeSelect.addEventListener('change', toggleByQtype);
    toggleByQtype();
  }

  function getTotalForms(){
    return totalFormsInput ? parseInt(totalFormsInput.value, 10) : 0;
  }
  function setTotalForms(n){
    if(totalFormsInput) totalFormsInput.value = String(n);
  }

  function reindexForms(){
    if(!container) return;
    const items = container.querySelectorAll('.choice-item');
    items.forEach((item, idx)=>{
      item.setAttribute('data-form-index', idx);
      item.querySelectorAll('input, select, textarea, label').forEach(node=>{
        if(node.name) node.name = node.name.replace(/-\d+-/, '-' + idx + '-');
        if(node.id) node.id = node.id.replace(/-\d+-/, '-' + idx + '-');
        if(node.htmlFor) node.htmlFor = node.htmlFor.replace(/-\d+-/, '-' + idx + '-');
      });
    });
  }

  if(addBtn && emptyTplEl){
    addBtn.addEventListener('click', function(){
      const idx = getTotalForms();
      let newHtml = emptyTplEl.innerHTML.replace(/__prefix__/g, idx);
      const wrapper = document.createElement('div');
      wrapper.innerHTML = newHtml;
      const newEl = wrapper.firstElementChild;
      newEl.classList.add('choice-item','mb-2','border','rounded','p-2');
      container.appendChild(newEl);
      setTotalForms(idx + 1);
      reindexForms();
    });
  }

  if(container){
    container.addEventListener('change', function(e){
      const target = e.target;
      if(!target) return;
      if(target.matches('input[type="checkbox"][name$="-is_correct"], input[type="checkbox"][id$="-is_correct"]')){
        if(target.checked){
          const boxes = container.querySelectorAll('input[type="checkbox"][name$="-is_correct"]');
          boxes.forEach(b => { if(b !== target) b.checked = false; });
        }
      }
    });

    container.addEventListener('click', function(e){
      if(e.target && e.target.classList.contains('remove-choice-btn')){
        const item = e.target.closest('.choice-item');
        if(!item) return;
        const delInput = item.querySelector('input[name$="-DELETE"]');
        if(delInput){
          delInput.value = 'on';
          item.style.display = 'none';
        } else {
          item.remove();
          setTotalForms(getTotalForms() - 1);
          reindexForms();
        }
      }
    });
  }

})();
</script>
{% endblock %}
