{% extends "base.html" %}
{% load static %}

{% block title %}<title>{% if form.instance.pk %}Edit Quiz{% else %}Create Quiz{% endif %}</title>{% endblock %}

{% block content %}
<div class="container py-3">
  <h2 class="mb-3">{% if form.instance.pk %}Edit Quiz{% else %}Create Quiz{% endif %}</h2>

  <form method="post" id="quiz-form">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}

    <div class="mb-3">
      {{ form.title.label_tag }}
      {{ form.title }}
      {% if form.title.errors %}
        <div class="text-danger small">{{ form.title.errors }}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      {{ form.description.label_tag }}
      {{ form.description }}
      {% if form.description.errors %}
        <div class="text-danger small">{{ form.description.errors }}</div>
      {% endif %}
    </div>

    {# Render actual form field as hidden so it doesn't create a visible input #}
    {{ form.time_limit_minutes.as_hidden }}

    {# Time limit interactive block (visible UI) #}
    <div id="time-limit-wrapper" class="mb-3">
      <div id="time-limit-controls">
        {% if form.instance and form.instance.time_limit_minutes %}
          <div id="time-limit-block" class="d-flex align-items-center">
            <label class="me-2">Time limit (minutes)</label>
            <input id="time-limit-input" type="number" min="1" class="form-control w-auto me-2" name="{{ form.time_limit_minutes.html_name }}" value="{{ form.instance.time_limit_minutes }}">
            <button type="button" class="btn btn-sm btn-outline-danger" id="remove-time-limit-btn">Remove</button>
          </div>
        {% else %}
          <button type="button" class="btn btn-sm btn-outline-primary" id="add-time-limit-btn">Add time limit</button>
        {% endif %}
      </div>
      <div class="form-text mt-1">Optional. Leave empty for no time limit.</div>
    </div>

    <div class="mt-3">
      <button class="btn btn-success" type="submit">Save</button>
      <a class="btn btn-secondary ms-2" href="{% url 'create_quiz:quiz_list' %}">Cancel</a>
    </div>
  </form>
</div>

<script>
(function(){
  const wrapper = document.getElementById('time-limit-wrapper');
  const controls = document.getElementById('time-limit-controls');

  const realInput = document.querySelector('input[name="{{ form.time_limit_minutes.html_name }}"]');

  function makeBlock(value){
    const div = document.createElement('div');
    div.id = 'time-limit-block';
    div.className = 'd-flex align-items-center';

    const label = document.createElement('label');
    label.className = 'me-2';
    label.innerText = 'Time limit (minutes)';

    const input = document.createElement('input');
    input.type = 'number';
    input.min = '1';
    input.className = 'form-control w-auto me-2';
    input.id = 'time-limit-input';
    input.name = realInput ? realInput.name : 'time_limit_minutes';
    if(value) input.value = value;

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-sm btn-outline-danger';
    btn.id = 'remove-time-limit-btn';
    btn.innerText = 'Remove';

    div.appendChild(label);
    div.appendChild(input);
    div.appendChild(btn);
    return div;
  }

  if(!realInput){
    const hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.name = 'time_limit_minutes';
    document.getElementById('quiz-form').appendChild(hidden);
  }

  const addBtn = document.getElementById('add-time-limit-btn');
  if(addBtn){
    addBtn.addEventListener('click', function(){
      const block = makeBlock('');
      controls.innerHTML = '';
      controls.appendChild(block);
      document.getElementById('time-limit-input').focus();
      attachRemoveHandler();
    });
  }

  function attachRemoveHandler(){
    const rem = document.getElementById('remove-time-limit-btn');
    if(!rem) return;
    rem.addEventListener('click', function(){
      const name = realInput ? realInput.name : 'time_limit_minutes';
      const exist = document.querySelector('input[name="'+name+'"]');
      if(exist) exist.value = '';
      controls.innerHTML = '<button type="button" class="btn btn-sm btn-outline-primary" id="add-time-limit-btn">Add time limit</button>';
      const nb = document.getElementById('add-time-limit-btn');
      if(nb){
        nb.addEventListener('click', function(){
          const block = makeBlock('');
          controls.innerHTML = '';
          controls.appendChild(block);
          attachRemoveHandler();
          document.getElementById('time-limit-input').focus();
        });
      }
    });
  }

  document.getElementById('quiz-form').addEventListener('submit', function(){
    const vis = document.getElementById('time-limit-input');
    if(vis){
      const name = vis.name;
      document.querySelectorAll('input[name="'+name+'"]').forEach(el=>{
        if(el !== vis){
          el.value = vis.value;
        }
      });
    }
    return true;
  });

  attachRemoveHandler();
})();
</script>
{% endblock %}
