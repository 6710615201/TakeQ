{% extends 'base.html' %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Room: {{ room.name }} ({{ room.code }})</h2>

    <div>
      {% if request.user == room.owner or role == 'owner' or role == 'admin' %}
        <a href="{% url 'create_quiz:quiz_create' %}?next={{ request.path }}" class="btn btn-primary btn-sm me-2">สร้าง quiz ใหม่</a>
        
        <button type="button"
          class="btn btn-outline-primary btn-sm me-2"
          data-bs-toggle="modal"
          data-bs-target="#inviteUserModal">
          เชิญสมาชิก
        </button>

        {% if request.user == room.owner or role == 'owner' %}
          <form method="post" action="{% url 'room:delete' room.code %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete this room? This action cannot be undone.');">ลบห้อง</button>
          </form>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <p>{{ room.description }}</p>
  <p>Owner: {{ room.owner }}</p>

  <hr/>

  <h3>Quizzes</h3>

  {# OWNER / ADMIN view #}
  {% if request.user == room.owner or role == 'owner' or role == 'admin' %}
    <h5 class="mt-3">Assigned quizzes</h5>
    <ul class="list-group mb-3">
      {% for a in assignments %}
        {% with q=a.quiz %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ q.title }}</strong>
            {% if q.is_published %}
              <span class="badge bg-success ms-2">เปิดให้ทำ</span>
            {% else %}
              <span class="badge bg-secondary ms-2">ปิด</span>
            {% endif %}
            <div class="small text-muted">Created by: {{ q.creator }}</div>
          </div>

          <div>
            <a href="{% url 'create_quiz:quiz_detail' q.pk %}" class="btn btn-outline-primary btn-sm me-1">ดู</a>
            <a href="{% url 'create_quiz:quiz_edit' q.pk %}" class="btn btn-outline-secondary btn-sm me-1">แก้ไข</a>

            <form method="post" action="{% url 'create_quiz:toggle_publish' q.pk %}" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}">
              {% if q.is_published %}
                <button type="submit" class="btn btn-sm btn-warning">ปิดการเข้าทำ</button>
              {% else %}
                <button type="submit" class="btn btn-sm btn-success">เปิดให้เข้าทำ</button>
              {% endif %}
            </form>
          </div>
        </li>
        {% endwith %}
      {% empty %}
        <li class="list-group-item">ยังไม่มี quiz ที่ถูกมอบหมายให้ห้องนี้</li>
      {% endfor %}
    </ul>

    <h5 class="mt-3">Your other quizzes (not assigned)</h5>
    <ul class="list-group mb-3">
      {% for q in owner_quizzes %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ q.title }}</strong>
            {% if q.is_published %}
              <span class="badge bg-success ms-2">เปิด</span>
            {% else %}
              <span class="badge bg-secondary ms-2">ปิด</span>
            {% endif %}
          </div>

          <div>
            <a href="{% url 'create_quiz:quiz_detail' q.pk %}" class="btn btn-outline-primary btn-sm me-1">ดู</a>
            <a href="{% url 'create_quiz:quiz_edit' q.pk %}" class="btn btn-outline-secondary btn-sm me-1">แก้ไข</a>

            <form method="post" action="{% url 'room:assign_quiz' room.code %}" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="quiz_id" value="{{ q.pk }}">
              <button type="submit" class="btn btn-sm btn-outline-success">Assign</button>
            </form>
          </div>
        </li>
      {% empty %}
        <li class="list-group-item">ไม่มี quiz อื่น ๆ ที่คุณสร้าง</li>
      {% endfor %}
    </ul>

  {% else %}
    {# STUDENT view: only assigned & published quizzes #}
    <h5 class="mt-3">Available quizzes</h5>
    <ul class="list-group mb-3">
      {% for q in visible_assigned_for_students %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ q.title }}</strong>
            <div class="small text-muted">Created by: {{ q.creator }}</div>
          </div>

          <div>
            <a href="{% url 'take_quiz:start_quiz' q.pk %}" class="btn btn-primary btn-sm">เริ่มทำ</a>
          </div>
        </li>
      {% empty %}
        <li class="list-group-item">ไม่มี quiz ที่เปิดให้เข้าทำในขณะนี้</li>
      {% endfor %}
    </ul>
  {% endif %}

  <hr/>

  <h3>Members</h3>
  <ul class="list-group mb-3">
    {% for m in members %}
      <li class="list-group-item">{{ m.user }} — {{ m.role }}</li>
    {% empty %}
      <li class="list-group-item">No members</li>
    {% endfor %}
  </ul>

</div>

<div class="modal fade" id="inviteUserModal" tabindex="-1" aria-labelledby="inviteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'room:invite' room.code %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="inviteUserModalLabel">เชิญสมาชิกเข้าห้อง</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="inviteUsername" class="form-label">Username or email</label>
            <input id="inviteUsername" name="username" type="text" class="form-control" required>
            <div class="form-text">Enter the username or email of the user to invite.</div>
          </div>

          <div class="mb-3">
            <label for="inviteRole" class="form-label">Role</label>
            <select id="inviteRole" name="role" class="form-select" required>
              {# If current user is admin, only show student option #}
              {% if role == 'admin' %}
                <option value="student" selected>Member</option>
              {% else %}
                {# owner (or others with permission) can choose admin or student #}
                <option value="admin">Admin</option>
                <option value="student" selected>Member</option>
              {% endif %}
            </select>
            <div class="form-text">Owner can invite as Admin or Member. Admin can invite only Members.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">Send invite</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
